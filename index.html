<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Διαχείριση Παραγγελιών</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, select, button {
      margin: 5px;
      padding: 5px;
    }
    .preview-img {
      height: 50px;
      cursor: pointer;
    }
    #previewSelectedImage {
      height: 100px;
      display: none;
      margin-top: 10px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .popup img {
      max-width: 90vw;
      max-height: 90vh;
    }
    .actions-column button {
      margin-right: 5px;
    }
    @media print {
      .no-print {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1>Διαχείριση Παραγγελιών</h1>

  <input type="file" id="imageInput" accept="image/*" class="no-print" />
  <br />
  <img id="previewSelectedImage" alt="Προεπισκόπηση Εικόνας" />
  <br />
  <select id="savedSelect" class="no-print"></select>
  <br />
  <input type="text" id="barcode" placeholder="Barcode" />
  <input type="text" id="description" placeholder="Περιγραφή" />
  <input type="number" id="quantity" placeholder="Ποσότητα" />
  <button onclick="addOrder()">Προσθήκη / Ενημέρωση</button>
  <button onclick="deleteAllOrders()" class="no-print">Διαγραφή Όλων</button>
  <button onclick="printPreview()" class="no-print">Εκτύπωση</button>
  <button onclick="exportPDF()" class="no-print">Εξαγωγή PDF</button>
  <br /><br />
  <input type="text" id="search" placeholder="Αναζήτηση" oninput="renderOrders()" />

  <table border="1" width="100%" id="orderTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Ημερομηνία</th>
        <th>Barcode</th>
        <th>Περιγραφή</th>
        <th>Ποσότητα</th>
        <th>Εικόνα</th>
        <th class="no-print">Ενέργειες</th>
      </tr>
    </thead>
    <tbody id="orderBody"></tbody>
  </table>

  <div class="popup" id="popup" onclick="this.style.display='none'">
    <img id="popupImg" alt="Μεγέθυνση Εικόνας" />
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const imageBaseURL = "orders/images/";

    const imageInput = document.getElementById('imageInput');
    const barcodeInput = document.getElementById('barcode');
    const descriptionInput = document.getElementById('description');
    const quantityInput = document.getElementById('quantity');
    const previewSelectedImage = document.getElementById('previewSelectedImage');
    const savedSelect = document.getElementById('savedSelect');

    let orders = JSON.parse(localStorage.getItem('orders') || '[]');
    let savedItems = JSON.parse(localStorage.getItem('savedItems') || '[]');

    let currentImageFile = "";  // data URL ή URL εικόνας
    let currentEdit = null;

    imageInput.addEventListener('change', function () {
      const file = this.files[0];
      if (file) {
        const fileName = file.name;
        const baseName = fileName.replace(/\.[^/.]+$/, "");

        const parts = baseName.split("_");
        if (parts.length >= 2) {
          barcodeInput.value = parts[0];
          descriptionInput.value = parts.slice(1).join(" ");
        } else {
          barcodeInput.value = baseName;
          descriptionInput.value = "";
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          previewSelectedImage.src = e.target.result;
          previewSelectedImage.style.display = 'inline-block';
          currentImageFile = e.target.result;
        };
        reader.readAsDataURL(file);

        savedSelect.value = "";
      }
    });

    function populateSavedSelect() {
      savedSelect.innerHTML = "<option value=''>-- Επιλογή Αποθηκευμένου Είδους --</option>";
      savedItems.forEach((item, i) => {
        savedSelect.innerHTML += `<option value="${i}">${item.barcode} - ${item.description}</option>`;
      });
    }

    savedSelect.addEventListener('change', function() {
      const index = this.value;
      if (index === '') {
        barcodeInput.value = '';
        descriptionInput.value = '';
        previewSelectedImage.style.display = 'none';
        currentImageFile = "";
      } else {
        const item = savedItems[index];
        barcodeInput.value = item.barcode;
        descriptionInput.value = item.description;

        const fileName = `${item.barcode}_${item.description.replace(/ /g, "_")}.jpg`;
        const imageUrl = `${imageBaseURL}${fileName}`;

        previewSelectedImage.src = imageUrl;
        previewSelectedImage.style.display = 'inline-block';
        currentImageFile = imageUrl;
      }
    });

    function addOrder() {
      const barcode = barcodeInput.value.trim();
      const description = descriptionInput.value.trim();
      const quantity = quantityInput.value.trim();

      if (!barcode || !description || !quantity) {
        alert("Συμπλήρωσε όλα τα πεδία.");
        return;
      }

      if (!savedItems.some(item => item.barcode === barcode)) {
        savedItems.push({ barcode, description });
        localStorage.setItem('savedItems', JSON.stringify(savedItems));
        populateSavedSelect();
      }

      let imagePath = currentImageFile;
      if (!currentImageFile.startsWith('data:')) {
        imagePath = `${imageBaseURL}${barcode}_${description.replace(/ /g, "_")}.jpg`;
      }

      const order = {
        barcode,
        description,
        quantity,
        date: new Date().toLocaleDateString(),
        image: imagePath
      };

      if (currentEdit !== null) {
        orders[currentEdit] = order;
        currentEdit = null;
      } else {
        orders.push(order);
      }

      localStorage.setItem('orders', JSON.stringify(orders));
      clearInputs();
      renderOrders();
    }

    function clearInputs() {
      barcodeInput.value = '';
      descriptionInput.value = '';
      quantityInput.value = '';
      imageInput.value = '';
      previewSelectedImage.style.display = 'none';
      currentImageFile = '';
      savedSelect.value = '';
    }

    function renderOrders() {
      const tbody = document.getElementById('orderBody');
      const searchText = document.getElementById('search').value.toLowerCase();
      tbody.innerHTML = "";

      orders.forEach((order, index) => {
        if (
          !order.barcode.toLowerCase().includes(searchText) &&
          !order.description.toLowerCase().includes(searchText) &&
          !order.date.toLowerCase().includes(searchText)
        ) {
          return;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${order.date}</td>
          <td>${order.barcode}</td>
          <td>${order.description}</td>
          <td>${order.quantity}</td>
          <td>
            <img src="${order.image}" class="preview-img" alt="Εικόνα" onclick="showPopup(this.src)" />
          </td>
          <td class="actions-column no-print">
            <button class="edit-btn" onclick="editOrder(${index})">✏️</button>
            <button class="delete-btn" onclick="deleteOrder(${index})">🗑️</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function showPopup(src) {
      const popup = document.getElementById('popup');
      const popupImg = document.getElementById('popupImg');
      popupImg.src = src;
      popup.style.display = 'flex';
    }

    function editOrder(index) {
      const order = orders[index];
      barcodeInput.value = order.barcode;
      descriptionInput.value = order.description;
      quantityInput.value = order.quantity;
      previewSelectedImage.src = order.image;
      previewSelectedImage.style.display = 'inline-block';
      currentImageFile = order.image;
      currentEdit = index;
      savedSelect.value = "";
    }

    function deleteOrder(index) {
      if (confirm("Είσαι σίγουρος ότι θέλεις να διαγράψεις αυτή την παραγγελία;")) {
        orders.splice(index, 1);
        localStorage.setItem('orders', JSON.stringify(orders));
        renderOrders();
      }
    }

    function deleteAllOrders() {
      if (confirm("Είσαι σίγουρος ότι θέλεις να διαγράψεις όλες τις παραγγελίες;")) {
        orders = [];
        localStorage.setItem('orders', JSON.stringify(orders));
        renderOrders();
      }
    }

    function printPreview() {
      window.print();
    }

    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const table = document.getElementById('orderTable');

      await html2canvas(table).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save('orders.pdf');
      });
    }

    // Αρχικοποίηση
    populateSavedSelect();
    renderOrders();
  </script>
</body>
</html>
